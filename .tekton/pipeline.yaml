---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: cd-pipeline
spec:
  params:
    - name: pipeline-debug
      description: toggles debug mode for the pipeline
    - name: compliance-baseimage
      description: base image to run most of the built-in pipeline code

  workspaces:
    - name: artifacts

  tasks:
    - name: prod-start
      taskRef:
        name: cd-start
      workspaces:
        - name: artifacts
          workspace: artifacts
      params:
        - name: compliance-baseimage
          value: $(params.compliance-baseimage)
        - name: pipeline-debug
          value: $(params.pipeline-debug)
        - name: next-stage
          value: setup

    - name: prod-setup
      taskRef:
        name: run-stage
      runAfter:
        - prod-start
      workspaces:
        - name: app
          workspace: artifacts
      params:
        - name: stage
          value: setup
        - name: image
          value: $(tasks.prod-start.results.image)
        - name: script
          value: $(tasks.prod-start.results.script)
        - name: configmap
          value: $(tasks.prod-start.results.configmap)
        - name: secret
          value: $(tasks.prod-start.results.secret)
        - name: abort-on-failure
          value: $(tasks.prod-start.results.abort-on-failure)
        - name: dind
          value: $(tasks.prod-start.results.dind)
        - name: image-pull-policy
          value: $(tasks.prod-start.results.image-pull-policy)
        - name: compliance-baseimage
          value: $(params.compliance-baseimage)
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: prod-change-request
      runAfter:
        - prod-setup
      taskRef:
        name: cd-change-request
      workspaces:
        - name: artifacts
          workspace: artifacts
      params:
        - name: compliance-baseimage
          value: $(params.compliance-baseimage)
        - name: pipeline-debug
          value: $(params.pipeline-debug)
        - name: next-stage
          value: deploy

    - name: prod-deployment
      taskRef:
        name: run-stage
      runAfter:
        - prod-change-request
      workspaces:
        - name: app
          workspace: artifacts
      params:
        - name: stage
          value: deploy
        - name: image
          value: $(tasks.prod-change-request.results.image)
        - name: script
          value: $(tasks.prod-change-request.results.script)
        - name: configmap
          value: $(tasks.prod-change-request.results.configmap)
        - name: secret
          value: $(tasks.prod-change-request.results.secret)
        - name: abort-on-failure
          value: $(tasks.prod-change-request.results.abort-on-failure)
        - name: dind
          value: $(tasks.prod-change-request.results.dind)
        - name: image-pull-policy
          value: $(tasks.prod-change-request.results.image-pull-policy)
        - name: compliance-baseimage
          value: $(params.compliance-baseimage)
        - name: pipeline-debug
          value: $(params.pipeline-debug)
        - name: next-stage
          value: acceptance-test

    - name: prod-acceptance-tests
      runAfter:
        - prod-deployment
      taskRef:
        name: run-stage
      workspaces:
        - name: app
          workspace: artifacts
      params:
        - name: stage
          value: acceptance-test
        - name: image
          value: $(tasks.prod-deployment.results.image)
        - name: script
          value: $(tasks.prod-deployment.results.script)
        - name: configmap
          value: $(tasks.prod-deployment.results.configmap)
        - name: secret
          value: $(tasks.prod-deployment.results.secret)
        - name: abort-on-failure
          value: $(tasks.prod-deployment.results.abort-on-failure)
        - name: dind
          value: $(tasks.prod-deployment.results.dind)
        - name: image-pull-policy
          value: $(tasks.prod-deployment.results.image-pull-policy)
        - name: compliance-baseimage
          value: $(params.compliance-baseimage)
        - name: pipeline-debug
          value: $(params.pipeline-debug)

    - name: prod-finish
      runAfter:
        - prod-acceptance-tests
      taskRef:
        name: cd-finish
      workspaces:
        - name: artifacts
          workspace: artifacts
      params:
        - name: compliance-baseimage
          value: $(params.compliance-baseimage)
        - name: pipeline-debug
          value: $(params.pipeline-debug)
