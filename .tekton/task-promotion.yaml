---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: inventory-promote
spec:
  params:
    - name: app-name
      description: name of the app to be deployed
      default: ""
    - name: source
      description: promotion source
    - name: target
      description: promotion target
    - name: branch
      description: the branch name
    - name: git-api-token-key
      description: github enterprise api token secret name
      default: "git-token"
    - name: retry-count
      description: retry count to pull and push git evidence repo
      default: "5"
    - name: retry-delay
      description: the amount of seconds between the retries
      default: "5"
    - name: pipeline-debug
      description: Pipeline debug mode
      default: "0"

  stepTemplate:
    env:
      - name: PIPELINE_DEBUG
        value: $(params.pipeline-debug)

  steps:
    - name: inventory-promote
      image: wcp-compliance-automation-team-docker-local.artifactory.swg-devops.com/ibm-compliance-automation:1.1.7@sha256:0d672453433c67d9146d2e9bc52575797c81eaff0654b4da4bf2a46dd8701a0b
      script: |
          #!/bin/bash
          set -e -o pipefail;

          if [ $PIPELINE_DEBUG == 1 ]; then
            env
            cat /cd-config/toolchain.json
            trap env EXIT
            set -x
          fi

          export GHE_TOKEN=$(cat "/secrets/$(params.git-api-token-key)")
          export INVENTORY_URL=$(jq -r '.services[] | select(.toolchain_binding.name=="inventory-repo")
          | .parameters.repo_url' /cd-config/toolchain.json)

          export GHE_REPO=$(echo "$INVENTORY_URL" | cut -f5 -d/ | cut -f1 -d.)
          export GHE_ORG=$(echo "$INVENTORY_URL" | cut -f4 -d/)

          TARGET=$(params.target)_candidate

          inventory_promote() {
            cd /artifacts/$GHE_REPO
            if [ "$(params.app-name)" == "" ]; then
              for app_name in *; do
                if [[ "$app_name" != *.md ]]; then
                  cocoa inventory promote --name="$app_name" --source="$(params.source)" --target="$TARGET" --branch="$(params.branch)"
                fi
              done
            else
              IFS=','
              read -ra app_names <<< "$(params.app-name)"
              for app_name in "${app_names[@]}"; do
                app_name="$(echo $app_name | sed -e 's/^[[:space:]]*//')"
                cocoa inventory promote --name="$app_name" --source="$(params.source)" --target="$TARGET" --branch="$(params.branch)"
              done
            fi
          }

          source /scripts/retry_command.sh

          retry $(params.retry-count) $(params.retry-delay) inventory_promote
          if [  $? -ne 0 ]; then
            echo "Error promoting build. There might be a github downtime, you can check it here: https://ibmtoolbox.statuspage.io"
            exit 1
          fi
      volumeMounts:
        - mountPath: /cd-config
          name: cd-config-volume
        - mountPath: /scripts
          name: retry-command

  workspaces:
    - name: artifacts
      mountPath: /artifacts
    - name: secrets
      mountPath: /secrets

  volumes:
    - name: cd-config-volume
      configMap:
        name: toolchain
        items:
          - key: toolchain.json
            path: toolchain.json
    - name: retry-command
      configMap:
        name: retry-command
        items:
          - key: retry_command.sh
            path: retry_command.sh
